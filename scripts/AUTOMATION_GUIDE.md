# Comprehensive Automation Scripts Guide for Umbrella-Stock

This guide documents all automation scripts available in the `scripts/` directory for managing stock and mutual fund data.

## ğŸ“Š **Stock Data Automation Scripts (Updated)**

### Core Working Scripts
| Script | NPM Command | Purpose | Status |
|--------|-------------|---------|--------|
| `bulk-manual-helper.js` | `npm run bulk-manual` | **Batch generator** - Creates organized batches of 50 stocks each from database | âœ… Working |
| `quick-batch-opener.js` | `npm run quick-batch` | **URL opener** - Opens stock URLs in manageable chunks of 10 | âœ… Working |
| `upload-any-files.js` | `npm run upload-any` | **Smart uploader** - Uploads any Excel files and matches company names to stock symbols | âœ… Working |
| `get-fresh-token.js` | `npm run get-token` | **Token refresher** - Gets fresh JWT token for admin authentication | âœ… Working |

### Legacy/Unused Scripts (For Reference Only)
| Script | Purpose | Status |
|--------|---------|--------|
| `final-automation.js` | Manual uploader for predefined 20 stocks | ğŸ“œ Legacy |
| `automate-stock-data.js` | Browser automation with Puppeteer | âš ï¸ Dependencies |
| `smart-bulk-stocks.js` | HTTP-based bulk automation | âŒ Blocked by Screener.in |
| `browser-bulk-stocks.js` | Advanced browser automation | âš ï¸ Dependencies |
| `auto-clicker.js` | Auto-clicking export buttons | âš ï¸ Dependencies |

## ğŸ¦ **Mutual Fund Data Scripts**

### Primary MF Automation
| Script | NPM Command | Purpose | Status |
|--------|-------------|---------|--------|
| `sync-mutual-funds.js` | `npm run sync-mutual-funds` | **Full MF sync** - Complete mutual fund data update from AMFI | âœ… Working |
| `sync-amfi-daily.js` | `npm run sync-mf-daily [date]` | **Daily NAV sync** - Updates daily NAV prices | âœ… Working |
| `fast-mf-data-update.js` | Manual run | **Bulk MF population** - Generates 8000+ fund records efficiently | âœ… Working |

### MF Data Enhancement
| Script | Purpose | Status |
|--------|---------|--------|
| `get-actual-mutual-fund-data.js` | Fetches real portfolio and AUM data using ISIN mapping | ğŸ“ˆ Enhancement |
| `check-fund.js` | Verifies specific fund details in database | ğŸ” Verification |
| `fetch-real-mf-data.js` | Legacy real MF data fetcher | ğŸ“œ Legacy |
| `populate-fund-details.js` | Legacy fund details population | ğŸ“œ Legacy |
| `scrape-all-mutual-fund-details.js` | Legacy scraping script | ğŸ“œ Legacy |
| `fix-commodity-funds.js` | Fixes commodity fund data issues | ğŸ”§ Maintenance |

## ğŸ› ï¸ **Configuration & Utilities**

### Core Configuration
| File | Purpose | Status |
|------|---------|--------|
| `config.js` | **Central configuration** - Stock symbols, API endpoints, JWT tokens | âš™ï¸ Core |
| `package.json` | **NPM scripts** - Defines all available npm commands | âš™ï¸ Core |

### Setup & Administration
| Script | Purpose | Status |
|--------|---------|--------|
| `init-admin-user.js` | Creates admin user (vinay.qss@gmail.com, password: 654321) | ğŸ‘¤ Setup |
| `test-upload.js` | Tests file upload functionality to admin panel | ğŸ§ª Testing |

## ğŸ–¥ï¸ **Generated Helper Files**

### Auto-Generated Scripts
| File | Purpose | Generated By |
|------|---------|-------------|
| `open-all-stocks.bat` | **Windows batch file** - Opens all 20 stock URLs in browser | `download-helper.js` |
| `download-helper.ps1` | **PowerShell version** - Formatted URL opener with colors | `download-helper.js` |
| `run-automation.bat` | **One-click automation** - Full workflow runner | Manual creation |

## âš¡ **Quick Reference Commands (Updated)**

### Stock Data Workflow (Current Working Method)
```bash
# 1. Generate organized batches (run once)
npm run bulk-manual

# 2. Process stocks in batches
npm run quick-batch 1     # Open first 10 URLs of batch 1
# Manually download Excel files from opened tabs
npm run upload-any        # Upload downloaded files

# 3. Continue with next mini-batch
npm run quick-batch 1 10  # Next 10 URLs in batch 1
npm run upload-any        # Upload files

# 4. Move to next batch
npm run quick-batch 2     # Start batch 2
npm run upload-any        # Upload files

# 5. If authentication fails
npm run get-token         # Get fresh JWT token
```

### Mutual Fund Workflow
```bash
# Daily NAV update (run daily)
npm run sync-mf-daily

# Full MF data sync (run weekly/monthly)
npm run sync-mutual-funds

# Bulk population (run once for setup)
node fast-mf-data-update.js
```

### Testing & Verification
```bash
# Test single stock upload
npm run test-one

# Check fund details
node check-fund.js

# Analyze Excel files
node analyze-all-sheets.js
```

## ğŸ“‹ **Available NPM Scripts (Updated)**

### From Main Package.json
- `npm run sync-mutual-funds` - Complete MF data synchronization
- `npm run sync-mf-daily [YYYY-MM-DD]` - Daily AMFI NAV sync

### From Scripts Package.json (Core Commands Only)
- `npm run bulk-manual` - Generate organized batches from database (2100 stocks â†’ 42 batches)
- `npm run quick-batch [batch] [start]` - Open URLs in manageable chunks (10 at a time)
- `npm run upload-any` - Smart upload any Excel files with automatic symbol matching
- `npm run get-token` - Get fresh JWT token for admin authentication

## ğŸ¯ **Stock Processing Scope (Updated)**

The current system processes **ALL stocks in your database**:
- **Total stocks**: ~2100 equity stocks from MongoDB
- **Source**: EquityStock collection (series: 'EQ', isActive: true)
- **Organization**: Divided into 42 batches of 50 stocks each
- **Processing**: 10 URLs opened at a time for manageable downloading
- **Smart matching**: Company names from Excel files â†’ Stock symbols in database

## âš™ï¸ **Configuration Requirements**

### Environment Variables
- `MONGODB_CONNECTION_URI` - MongoDB connection string
- `ADMIN_TOKEN` - JWT token for admin API access (auto-configured in config.js)

### File Paths & Endpoints
- Downloads folder: `./downloads`
- Config file: `./config.js`
- Stock data API: `http://localhost:3000/api/admin/stock-details/`
- Admin base URL: `http://localhost:3000/admin/`

### Authentication
- Admin email: `vinay.qss@gmail.com`
- Admin password: `654321`
- JWT token: Auto-configured in `config.js`

## ğŸ“Š **Data Sources**

### Stock Data
- **Screener.in** - Excel export functionality
- **Manual download** - Export to Excel button on each stock page
- **File format** - XLSX files with financial statements

### Mutual Fund Data
- **AMFI Portal** - NAVAll.txt for daily NAV data
- **MFAPI** - Enhanced fund details and historical returns
- **ISIN Mapping** - Portfolio and AUM data

## ğŸ”„ **Automation Workflows**

### Stock Data Pipeline
1. **Download Phase**: Open stock pages â†’ Click export â†’ Save Excel files
2. **Processing Phase**: Rename files â†’ Parse Excel data â†’ Extract financials
3. **Upload Phase**: Send to admin API â†’ Store in MongoDB â†’ Update equity stocks

### Mutual Fund Pipeline
1. **Fetch Phase**: Download AMFI data â†’ Parse fund details â†’ Get MFAPI data
2. **Processing Phase**: Calculate returns â†’ Enrich metadata â†’ Validate data
3. **Storage Phase**: Update MongoDB â†’ Index for search â†’ Cache for performance

## ğŸš¨ **Troubleshooting**

### Common Issues
- **Token expired**: Update JWT token in `config.js`
- **File not found**: Check download folder and file names
- **Upload failed**: Verify server running on localhost:3000
- **Permission denied**: Ensure admin role in JWT token

### File Issues
- **Wrong filenames**: Run `npm run rename-files`
- **Missing files**: Check downloads folder, re-download if needed
- **Corrupted Excel**: Re-download from Screener.in

### Server Issues
- **404 errors**: Ensure Next.js app is running
- **403 errors**: Check JWT token validity
- **500 errors**: Check MongoDB connection

## ğŸ“ˆ **Performance Tips (Updated)**

### Stock Automation (Current Method)
- **Process in small chunks**: 10 URLs at a time to avoid browser overload
- **Upload frequently**: Don't wait for entire batch, upload as you download
- **Use batch organization**: 50 stocks per batch makes progress trackable
- **Monitor token expiry**: Run `npm run get-token` when getting 403 errors
- **Smart file matching**: System automatically matches company names to symbols

### Estimated Timeline for All 2100 Stocks
- **Per stock**: ~30 seconds (open page + download + upload)
- **Per 10-stock chunk**: ~5 minutes
- **Per 50-stock batch**: ~25 minutes
- **Total time**: ~17-20 hours (spread over multiple sessions)

### Mutual Fund Sync
- Run daily sync (`npm run sync-mf-daily`) for NAV updates
- Run full sync (`npm run sync-mutual-funds`) weekly for new funds
- Use fast update (`fast-mf-data-update.js`) for bulk initial population

## ğŸ”® **Future Enhancements**

### Planned Features
- Browser automation improvements for direct downloads
- Scheduled automation using cron jobs
- Enhanced error recovery and retry logic
- Progress tracking and notifications
- API rate limiting and respect for source websites

### Potential Integrations
- NSE/BSE direct API integration
- Real-time data feeds
- Email notifications for completion
- Slack/Teams integration for alerts

---

## ğŸ“ **Support**

For issues or questions:
1. Check this guide first
2. Review script logs for error messages
3. Verify JWT token with `npm run get-token`
4. Ensure Next.js server is running on localhost:3000
5. Check MongoDB Atlas connection

## ğŸ¯ **Current Status & Progress Tracking**

### Batch Progress Tracking
- **Batch 1**: âœ… Complete (~50 stocks uploaded)
- **Batch 2-42**: â³ Pending
- **Total Progress**: ~2.4% complete (50/2100 stocks)

### Success Metrics
- **Upload success rate**: ~95% (when JWT token is valid)
- **Symbol matching rate**: ~96% (company names â†’ stock symbols)
- **Common issues**: JWT token expiry, company name variations

**Last Updated**: September 2025
**Version**: 2.0.0 (Updated for 2100 stock automation)
**Maintainer**: Admin Team